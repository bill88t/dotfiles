#!/usr/bin/env python3

import subprocess
import sys
import re
import os
from urllib.parse import urlparse
import getpass

seq = 0

def find_urls(text):
    return re.findall(r'https?://[^\s/$.?#].[^\s]*', text)

def download_url(url):
    global seq
    mid = seq
    seq += 1
    try:
        path = urlparse(url).path
        filename = os.path.basename(path)

        if not filename:
            print(f"Could not determine filename for URL: {url}. Skipping.", file=sys.stderr)
            return

        print(f"Starting download #{mid} for: {url}")

        command = ['wget', url, '-qO', filename]
        subprocess.Popen(command, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    except Exception as e:
        print(f"An error occurred while processing {url}: {e}", file=sys.stderr)

def main():
    print("Crude downloader started. Paste links and press Enter.")
    print("Press Ctrl+C or Ctrl+D to exit.")

    while True:
        try:
            pasted_text = getpass.getpass(prompt='')
            urls = find_urls(pasted_text)

            if not urls:
                continue

            for url in urls:
                download_url(url)
        except EOFError:
            print("\nCtrl+D detected. Exiting.")
            break
        except KeyboardInterrupt:
            print("\nCtrl+C detected. Exiting.")
            break

if __name__ == "__main__":
    if subprocess.run(['which', 'wget'], capture_output=True).returncode != 0:
        print("Error: 'wget' is not installed or not in your PATH. Please install it to use this script.", file=sys.stderr)
        sys.exit(1)

    main()

